# Updater (beta)

![license](https://img.shields.io/badge/license-Apache%202-blue)
[![build status](https://travis-ci.com/jamielsharief/updater.svg?branch=main)](https://travis-ci.com/jamielsharief/updater)
[![coverage status](https://coveralls.io/repos/github/jamielsharief/updater/badge.svg?branch=travis-issues)](https://coveralls.io/github/jamielsharief/updater?branch=travis-issues)

Have you ever wanted that your applications can automatically update or automate the update process between releases? well now you can!

This works alongside [composer](https://getcomposer.org/), it works with its packages and authorization configuration files. Updater currently supports public packages on [packagist.org](https://packagist.org/) and private packages on a static repository generated by [satis](https://getcomposer.org/doc/articles/handling-private-packages.md).

```bash
$ updater update
     __  __          __      __
    / / / /___  ____/ /___ _/ /____  _____
   / / / / __ \/ __  / __ `/ __/ _ \/ ___/
  / /_/ / /_/ / /_/ / /_/ / /_/  __/ /
  \____/ .___/\__,_/\__,_/\__/\___/_/
      /_/


- Checking for updates company/app (1.0.2)
- Downloading company/app (1.0.3)
- Running before scripts:
 > bin/console backup
- Extracting company/app (1.0.3)
- Running after scripts:
 > composer update
 > bin/console db:migrate
```

## Installation

Download the source and build `updater` application.

```bash
$ git clone http://github.com/jamielsharief/updater updater
$ cd updater
$ composer run-script build
```

The composer script will create `bin/updater.phar`, you can copy this into your application `bin` folder.

To install globally:

```bash
$ cp bin/updater.phar /usr/local/bin/updater
```

## Usage

Create `updater.json` in your application project folder, and in each release you can configure it to run `before` and `after` commands, bash or PHP scripts - if and when needed.

```json
{
    "url": "https://packagist.org",
    "package": "company/app",
    "scripts": {
        "before": [
            "bin/console db:backup"
        ],
        "after": [
            "bin/console db:migrate"
        ]
    }
}
```

If you are using a private [satis repository](https://getcomposer.org/doc/articles/handling-private-packages.md), change the `url` in the `updater.json` , e.g. `https://www.example.com` and setup authentication for `composer`, if required.


### Authentication

Currently only `http-basic` authorization is supported, to work with this simply create the `auth.json` in your project directory. However you can also generate a satis private repository which can then connect to various repositories and supports more authentication methods.

```json
{
    "http-basic": {
        "localhost": {
            "username": "user",
            "password": "1234"
        },
    }
}
```

> Composer can create this for you as well `composer config http-basic.example.com username password --global`


### Initializing the Project

To get started with `updater` you need to initialize the project.

Run the `updater init` command to initialize the updater, you will be prompted for the current version, and updates
after this will be pulled.

```bash
$ updater  init
```

### Updating

To update your application just run the following command, which will run all updates that are available in sequence.

```bash
$ updater update --all
```

## Demo

> This demo assumes you have downloaded the source of `updater` and you are going to download the source of `updater-demo` and place this in the demo subfolder.

First download the source for the `updater` and run `composer install`, then download the `updater-demo` into the `demo` directory.

```bash
$ composer create-project jamielsharief/updater-demo:0.1.0 demo
```

Create `updater.json` in `demo` folder, set the URL to the repository.

```json
{
    "url": "https://packagist.org",
    "package": "jamielsharief/updater-demo",
    "scripts": {
        "before": [],
        "after": []
    }
}
```

Initialize `updater`, mentioning the directory where you extracted the zip archive too.

```bash
$ bin/updater init demo --version 0.1.0
```

Then run the `update` command to get the next available update

```bash
$ bin/updater update demo
```

## Building the Updater.phar

To build the `bin/updater.phar` run the following command

```bash
$ composer run-script build
```

## Testing

To setup for testing you need [Docker](https://docs.docker.com/get-docker/), and build the image. This will create a small web sever with the satis repository.

```bash
$ cd tests/TestServer
$ docker build -t satis-dev .
```

Anytime you want to fire up the Docker container, which will make `http://localhost:8000` available.

```bash
$ docker run -d -p 8000:80 satis-dev
```

If you goto `http://localhost:8000` you should see a repository page.


Fetch the development dependencies

```bash
$ composer update --dev
```

To run the `PHPUnit` tests

```bash
$ vendor/bin/phpunit
```